(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["1d42d2f7"],{"50a2":function(t,e,s){"use strict";var i=s("ba91"),n=s.n(i);n.a},"9bfb":function(t,e,s){"use strict";var i=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"title-bar"},[s("q-icon",{staticClass:"title-back-icon",attrs:{name:"navigate_before"},nativeOn:{click:function(e){return t.goBack(e)}}}),s("div",{staticClass:"title-tx"},[t._v(t._s(t.titleTx))])],1)},n=[];i._withStripped=!0;var o={props:["titleTx"],methods:{goBack:function(){this.$router.go(-1)}}},a=o,r=(s("a675"),s("2877")),l=Object(r["a"])(a,i,n,!1,null,null,null);l.options.__file="TitleBar.vue";e["a"]=l.exports},a675:function(t,e,s){"use strict";var i=s("ca51"),n=s.n(i);n.a},ab55:function(t,e,s){"use strict";s.r(e);var i=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"mypage"},[s("TitleBar",{attrs:{titleTx:t.converData.nickName}}),s("div",{staticClass:"myblock",staticStyle:{"overflow-y":"auto",flex:"1"}},t._l(t.messages,function(t,e){return s("q-chat-message",{key:"reg-"+e,attrs:{label:t.label,sent:t.sent,"text-color":t.textColor,"bg-color":t.bgColor,name:t.name,avatar:t.avatar,text:t.text,stamp:t.stamp}})})),s("div",{staticStyle:{display:"flex",margin:"10px"}},[s("q-input",{staticStyle:{flex:"1"},model:{value:t.sendTx,callback:function(e){t.sendTx=e},expression:"sendTx"}}),s("q-btn",{staticStyle:{width:"20%","margin-left":"5px"},attrs:{label:"发送",color:"primary"},on:{click:t.sendMsg}})],1)],1)},n=[];i._withStripped=!0;s("6b54");var o=s("9bfb"),a=s("3452"),r=s.n(a),l=s("6821f"),c=s.n(l),g={components:{TitleBar:o["a"]},data:function(){return{converData:{},sendTx:"",messages:[]}},mounted:function(){console.log("-----Chat mounted"),this.converData=this.$route.query.item,JIM.isInit()?JIM.isLogin()?(this.onlinemsgreceive(),this.showUnreadMsg()):this.jimlogin():this.jiminit()},methods:{showUnreadMsg:function(){for(var t=[],e=this.global.jim.offlineMsg,s=0;s<e.length;s++)if(e[s].from_username===this.converData.username){for(var i=e[s].msgs,n=[],o=0;o<i.length;o++)this.showMsg(i[o].content.msg_body.text,this.util.convertUTCTimeToLocalTime(i[o].ctime_ms).substring(5)),n.push(i[o].msg_id);this.singleReceiptReport(n),t.push(s);break}for(var a=0;a<t.length;a++)this.global.jim.offlineMsg.splice(t[a],1);t=[];for(var r=this.global.jim.onlineMsg,l=[],c=0;c<r.length;c++)r[c].from_username===this.converData.username&&(this.showMsg(r[c].text,this.util.convertUTCTimeToLocalTime(r[c].ctime_ms).substring(5)),l.push(r[c].msg_id),t.push(c));this.singleReceiptReport(l);for(var g=0;g<t.length;g++)this.global.jim.onlineMsg.splice(t[g],1)},singleReceiptReport:function(t){0!==t.length&&JIM.addSingleReceiptReport({username:this.converData.username,msg_ids:t}).onSuccess(function(t,e){console.log("回执成功")}).onFail(function(t,e){console.log("回执失败")})},onlinemsgreceive:function(){var t=this;JIM.onMsgReceive(function(e){for(var s=e.messages,i=0;i<s.length;i++)if(s[i].from_username===t.converData.username){t.showMsg(s[i].content.msg_body.text,t.util.convertUTCTimeToLocalTime(s[i].content.create_time).substring(5));var n=[];n.push(s[i].msg_id),t.singleReceiptReport(n)}else t.global.jim.onlineMsg.push({ctime_ms:s[i].ctime_ms,from_username:s[i].from_username,msg_id:s[i].msg_id,text:s[i].content.msg_body.text});console.log("this.global.jim.onlineMsg"),console.log(t.global.jim.onlineMsg)})},showMsg:function(t,e){var s=r.a.AES.decrypt(t,this.global.jim.aeskey),i=s.toString(r.a.enc.Utf8);this.messages.push({name:"",text:[i],sent:!1,avatar:"statics/left.png",stamp:e});var n=document.querySelector(".myblock");this.$nextTick(function(){n.scrollTop=n.scrollHeight})},jiminit:function(){var t=this;window.JIM=new JMessage({debug:this.global.jim.debug});var e={appkey:this.global.jim.appkey,random_str:this.util.randomWord(!0,20,36),signature:"",timestamp:(new Date).getTime(),flag:this.global.jim.flag};e.signature=c()("appkey="+e.appkey+"&timestamp="+e.timestamp+"&random_str="+e.random_str+"&key="+this.global.jim.secret),JIM.init(e).onSuccess(function(e){console.log("success:"+JSON.stringify(e)),t.jimlogin()}).onFail(function(t){console.log("error:"+JSON.stringify(t))})},jimlogin:function(){var t=this,e=this.global.wallet.ethAddress;JIM.login({username:e===this.global.jim.ok0x?"ok0x":e.substring(2),password:"123456"}).onSuccess(function(e){console.log("success:"+JSON.stringify(e)),t.onlinemsgreceive(),t.showUnreadMsg()}).onFail(function(e){console.log("error:"+JSON.stringify(e)),880103===e.code&&t.jimregister()}).onTimeout(function(t){console.log("timeout:"+JSON.stringify(t))})},jimregister:function(){var t=this,e=this.global.wallet.ethAddress;JIM.register({username:e===this.global.jim.ok0x?"ok0x":e.substring(2),password:"123456",nickname:this.global.wallet.ethAddress.substring(37)}).onSuccess(function(e){console.log("success:"+JSON.stringify(e)),t.jimlogin()}).onFail(function(t){console.log("error:"+JSON.stringify(t))})},sendMsg:function(){var t=this;if(!JIM.isInit())return toast("正在重新连接,请稍后..."),void this.jiminit();if(!JIM.isLogin())return toast("正在重新连接,请稍后..."),void this.jimlogin();if(""!==this.sendTx){var e=r.a.AES.encrypt(this.sendTx,this.global.jim.aeskey);JIM.sendSingleMsg({target_username:this.converData.username,content:e.toString()}).onSuccess(function(e,s){t.messages.push({name:"",text:[t.sendTx],sent:!0,avatar:"statics/right.png",stamp:(new Date).toLocaleString()}),t.sendTx="";var i=document.querySelector(".myblock");t.$nextTick(function(){i.scrollTop=i.scrollHeight})}).onFail(function(t){console.log("6666666666^^^^^^^^^^^^^^"),console.log(t)})}}},beforeDestroy:function(){JIM.resetUnreadCount({username:this.converData.username}),console.log("-----Chat beforeDestroy")}},m=g,u=(s("50a2"),s("2877")),f=Object(u["a"])(m,i,n,!1,null,"5fc5fce6",null);f.options.__file="Chat.vue";e["default"]=f.exports},ba91:function(t,e,s){},ca51:function(t,e,s){}}]);